rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Chapters collection
    match /chapters/{chapterId} {

      // Anyone can read public and anonymous chapters
      // Private chapters only readable by the author
      // Friends chapters only readable by the author (until friends system is built)
      allow read: if resource.data.privacy == 'public'
                  || resource.data.privacy == 'anonymous'
                  || !('privacy' in resource.data)
                  || (request.auth != null && resource.data.authorId == request.auth.uid);

      // Only authenticated users can create chapters
      // Author ID must match the authenticated user
      allow create: if request.auth != null
                    && request.resource.data.authorId == request.auth.uid
                    && request.resource.data.privacy in ['private', 'public', 'anonymous', 'friends'];

      // Only the author can update their own chapters
      allow update: if request.auth != null
                    && resource.data.authorId == request.auth.uid
                    && request.resource.data.authorId == request.auth.uid;

      // Only the author can delete their own chapters
      allow delete: if request.auth != null
                    && resource.data.authorId == request.auth.uid;

      // Likes subcollection - tracks who liked a chapter
      match /likes/{likeId} {
        // Anyone can read likes
        allow read: if true;
        // Authenticated users can like (likeId must be their uid)
        allow create: if request.auth != null && likeId == request.auth.uid;
        // Users can only remove their own like
        allow delete: if request.auth != null && likeId == request.auth.uid;
      }

      // Resonates subcollection - tracks who resonated with a chapter
      match /resonates/{resonateId} {
        allow read: if true;
        allow create: if request.auth != null && resonateId == request.auth.uid;
        allow delete: if request.auth != null && resonateId == request.auth.uid;
      }
    }

    // Suggested events collection — community event suggestions with voting
    match /suggestedEvents/{eventId} {
      // Anyone can read suggestions
      allow read: if true;

      // Authenticated users can create suggestions
      allow create: if request.auth != null
                    && request.resource.data.suggestedBy == request.auth.uid;

      // Allow authenticated users to update votes
      allow update: if request.auth != null;

      // Only the author can delete their suggestion
      allow delete: if request.auth != null
                    && resource.data.suggestedBy == request.auth.uid;

      // Voters subcollection — tracks who voted for each suggestion
      match /voters/{voterId} {
        allow read: if true;
        // Authenticated users can vote (voterId must be their uid)
        allow create: if request.auth != null && voterId == request.auth.uid;
        // Users can only remove their own vote
        allow delete: if request.auth != null && voterId == request.auth.uid;
      }
    }
  }
}
